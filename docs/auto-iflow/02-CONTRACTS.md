# ğŸ“œ ĞšĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ»Ğ¾ÑĞ¼Ğ¸

**Ğ¦ĞµĞ»ÑŒ:** ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ‚ĞºĞ¸Ğµ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ñ‹ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹.

---

## ğŸ— ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ÑĞ»Ğ¾ĞµĞ²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (Electron/Vue)                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ Kanban View â”‚  â”‚ Agent View  â”‚  â”‚ Planning View           â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ IPC / WebSocket
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API GATEWAY (FastAPI)                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ Session API â”‚  â”‚ Event API   â”‚  â”‚ Planning API            â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ Internal calls
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ORCHESTRATOR (Python)                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ AgentPool   â”‚  â”‚ EventBus    â”‚  â”‚ BrainstormingModule     â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ SDK calls
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        iFlow SDK Layer                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ IFlowClient â”‚  â”‚ EventStream â”‚  â”‚ ToolExecutor            â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ ACP Protocol
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        STORAGE (SQLite + Git)                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ SessionDB   â”‚  â”‚ EventLog    â”‚  â”‚ ArtifactStore (Git)     â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Event Schema

### Base Event

```typescript
interface BaseEvent {
  event_id: string;           // UUID
  timestamp: string;          // ISO 8601
  session_id: string;         // Session UUID
  agent_id: string | null;    // Agent identifier (null for system events)
  event_type: EventType;
}

type EventType = 
  | "session.started"
  | "session.ended"
  | "agent.spawned"
  | "agent.message"
  | "agent.thought"
  | "agent.tool_call"
  | "agent.tool_result"
  | "agent.plan"
  | "agent.finished"
  | "agent.error"
  | "file.created"
  | "file.modified"
  | "file.deleted"
  | "git.commit"
  | "git.merge"
  | "planning.question"
  | "planning.answer"
  | "planning.synthesis";
```

### Agent Events

```typescript
// Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
interface AgentMessageEvent extends BaseEvent {
  event_type: "agent.message";
  payload: {
    content: string;
    is_streaming: boolean;
    chunk_index?: number;
  };
}

// Ğ’Ñ‹Ğ·Ğ¾Ğ² Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ°
interface AgentToolCallEvent extends BaseEvent {
  event_type: "agent.tool_call";
  payload: {
    tool_name: string;
    tool_id: string;
    args: Record<string, any>;
    status: "pending" | "running" | "completed" | "failed";
  };
}

// Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ°
interface AgentToolResultEvent extends BaseEvent {
  event_type: "agent.tool_result";
  payload: {
    tool_id: string;
    output: string;
    error?: string;
    duration_ms: number;
  };
}

// Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
interface AgentFinishedEvent extends BaseEvent {
  event_type: "agent.finished";
  payload: {
    stop_reason: "end_turn" | "max_tokens" | "refusal" | "cancelled";
    total_tokens: number;
    duration_ms: number;
  };
}
```

### Planning Events

```typescript
// Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ ĞºĞ¾Ğ½ÑĞ¸Ğ»Ğ¸ÑƒĞ¼Ğ°
interface PlanningQuestionEvent extends BaseEvent {
  event_type: "planning.question";
  payload: {
    question_index: number;
    question_text: string;
    category: "WHAT" | "WHY" | "WHERE" | "WHEN" | "EXPECTATIONS" | "WHO" | "JOURNEY" | "VALUE";
    context_from_search: SearchContext[];
  };
}

interface SearchContext {
  source: string;
  url: string;
  snippet: string;
  trust_score: number;  // 0.0 - 1.0
}

// ĞÑ‚Ğ²ĞµÑ‚ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° ĞºĞ¾Ğ½ÑĞ¸Ğ»Ğ¸ÑƒĞ¼Ğ°
interface PlanningAgentOpinionEvent extends BaseEvent {
  event_type: "planning.synthesis";
  payload: {
    agent_role: "innovator" | "realist" | "facilitator";
    opinion: string;
    supporting_facts: string[];
    concerns: string[];
  };
}
```

---

## ğŸ“‚ Session State Model

```typescript
interface Session {
  id: string;                    // UUID
  created_at: string;            // ISO 8601
  updated_at: string;            // ISO 8601
  status: SessionStatus;
  project_path: string;
  git_branch: string;
  
  // ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
  config: SessionConfig;
  
  // Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
  agents: AgentState[];
  planning: PlanningState | null;
  
  // ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
  metadata: Record<string, any>;
}

type SessionStatus = 
  | "initializing"
  | "planning"
  | "executing"
  | "reviewing"
  | "merging"
  | "completed"
  | "failed"
  | "cancelled";

interface SessionConfig {
  max_agents: number;            // Default: 12
  approval_mode: "DEFAULT" | "AUTO_EDIT" | "YOLO" | "PLAN";
  timeout_seconds: number;       // Default: 3600
  auto_commit: boolean;
  auto_merge: boolean;
}

interface AgentState {
  agent_id: string;
  task_id: string;
  status: "idle" | "running" | "completed" | "failed";
  worktree_path: string;
  current_tool: string | null;
  messages_count: number;
  tokens_used: number;
  started_at: string | null;
  finished_at: string | null;
}

interface PlanningState {
  phase: "interviewing" | "synthesizing" | "completed";
  current_question: number;      // 0-7 for 8 questions
  answers: PlanningAnswer[];
  concept_draft: string | null;
  
  // ĞœĞ½ĞµĞ½Ğ¸Ñ Ğ°Ğ³ĞµĞ½Ñ‚Ğ¾Ğ²
  innovator_opinion: string | null;
  realist_opinion: string | null;
  facilitator_opinion: string | null;
}

interface PlanningAnswer {
  question_index: number;
  user_answer: string;
  search_context: SearchContext[];
  agent_analyses: AgentAnalysis[];
}

interface AgentAnalysis {
  role: "innovator" | "realist" | "facilitator";
  analysis: string;
  recommendations: string[];
}
```

---

## ğŸ’¾ Storage Model

### SQLite Tables

```sql
-- Ğ¡ĞµÑÑĞ¸Ğ¸
CREATE TABLE sessions (
  id TEXT PRIMARY KEY,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  status TEXT NOT NULL,
  project_path TEXT NOT NULL,
  git_branch TEXT NOT NULL,
  config_json TEXT NOT NULL,
  metadata_json TEXT
);

-- ĞĞ³ĞµĞ½Ñ‚Ñ‹
CREATE TABLE agents (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL REFERENCES sessions(id),
  task_id TEXT NOT NULL,
  status TEXT NOT NULL,
  worktree_path TEXT NOT NULL,
  current_tool TEXT,
  messages_count INTEGER DEFAULT 0,
  tokens_used INTEGER DEFAULT 0,
  started_at TEXT,
  finished_at TEXT
);

-- Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (append-only log)
CREATE TABLE events (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL REFERENCES sessions(id),
  agent_id TEXT REFERENCES agents(id),
  event_type TEXT NOT NULL,
  timestamp TEXT NOT NULL,
  payload_json TEXT NOT NULL
);

-- Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹
CREATE INDEX idx_events_session ON events(session_id, timestamp);
CREATE INDEX idx_events_agent ON events(agent_id, timestamp);
CREATE INDEX idx_events_type ON events(event_type);

-- Planning Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹
CREATE TABLE planning_artifacts (
  id TEXT PRIMARY KEY,
  session_id TEXT NOT NULL REFERENCES sessions(id),
  artifact_type TEXT NOT NULL,  -- 'concept', 'tasks', 'research'
  version INTEGER NOT NULL,
  content TEXT NOT NULL,
  created_at TEXT NOT NULL,
  git_commit TEXT
);

CREATE INDEX idx_artifacts_session ON planning_artifacts(session_id, artifact_type);
```

### Git Artifact Store

```
.iflow/
â”œâ”€â”€ config.yaml              # ĞŸÑ€Ğ¾ĞµĞºÑ‚Ğ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
â”œâ”€â”€ prompts/                 # ĞšĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹
â”‚   â”œâ”€â”€ system.md
â”‚   â”œâ”€â”€ innovator.md
â”‚   â”œâ”€â”€ realist.md
â”‚   â””â”€â”€ facilitator.md
â”œâ”€â”€ docs/                    # Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹
â”‚   â”œâ”€â”€ concept.md           # â† Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ² Git
â”‚   â”œâ”€â”€ tasks.json           # â† Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ² Git
â”‚   â””â”€â”€ research/
â”‚       â”œâ”€â”€ competitors.md
â”‚       â””â”€â”€ market.md
â”œâ”€â”€ history/                 # Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ (SQLite backup)
â”‚   â””â”€â”€ events.db
â””â”€â”€ cache/                   # ĞšĞµÑˆ Ğ¿Ğ¾Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
    â””â”€â”€ search_cache.json
```

---

## ğŸ”„ Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ UI â†” Backend

### Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ: Event Sourcing + CQRS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend  â”‚â—„â”€â”€â”€â”€â”€â”€â”‚  EventBus   â”‚â—„â”€â”€â”€â”€â”€â”€â”‚ Orchestratorâ”‚
â”‚   (Vue)     â”‚       â”‚ (WebSocket) â”‚       â”‚  (Python)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚                     â”‚
       â”‚  Subscribe          â”‚                     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚
       â”‚                     â”‚                     â”‚
       â”‚                     â”‚     Emit event      â”‚
       â”‚                     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚   Push event        â”‚                     â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚
       â”‚                     â”‚                     â”‚
       â”‚  Query state        â”‚                     â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚
       â”‚                     â”‚     Get state       â”‚
       â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                     â”‚     Return state    â”‚
       â”‚   Return state      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚
```

### ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹

1. **Single Source of Truth:** Backend (Orchestrator + SQLite)
2. **Frontend:** Read-only view + command dispatch
3. **Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:** Event push Ñ‡ĞµÑ€ĞµĞ· WebSocket
4. **Reconnection:** Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ state Ğ¿Ñ€Ğ¸ reconnect
5. **Optimistic UI:** ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ (ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ°Ğ³ĞµĞ½Ñ‚Ğ¾Ğ²)

### WebSocket Protocol

```typescript
// Client â†’ Server
interface ClientMessage {
  type: "subscribe" | "unsubscribe" | "command";
  payload: any;
}

interface SubscribePayload {
  session_id: string;
  event_types?: EventType[];  // null = all
}

interface CommandPayload {
  command: "start_session" | "stop_agent" | "cancel_session" | "answer_question";
  session_id: string;
  args: Record<string, any>;
}

// Server â†’ Client
interface ServerMessage {
  type: "event" | "state_snapshot" | "error";
  payload: any;
}

interface StateSnapshotPayload {
  session: Session;
  recent_events: BaseEvent[];  // Last 100 events
}
```

---

## ğŸ”’ Ğ“Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸

### Frontend

| ĞĞ±Ğ»Ğ°ÑÑ‚ÑŒ | ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ |
|---------|-----------------|
| UI rendering | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| Event display | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| User input | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| State management | âŒ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞµÑˆ UI |
| Business logic | âŒ ĞĞµÑ‚ |
| Agent control | âŒ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ |

### API Gateway

| ĞĞ±Ğ»Ğ°ÑÑ‚ÑŒ | ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ |
|---------|-----------------|
| Auth/AuthZ | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| Rate limiting | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| Request validation | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| Response formatting | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| Business logic | âŒ Ğ”ĞµĞ»ĞµĞ³Ğ¸Ñ€ÑƒĞµÑ‚ Orchestrator |

### Orchestrator

| ĞĞ±Ğ»Ğ°ÑÑ‚ÑŒ | ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ |
|---------|-----------------|
| Agent lifecycle | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| Event emission | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| State management | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| SDK integration | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| Storage | âŒ Ğ”ĞµĞ»ĞµĞ³Ğ¸Ñ€ÑƒĞµÑ‚ Storage Layer |

### Storage

| ĞĞ±Ğ»Ğ°ÑÑ‚ÑŒ | ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ |
|---------|-----------------|
| Persistence | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| Transactions | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| Indexing | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| Git integration | âœ… ĞŸĞ¾Ğ»Ğ½Ğ°Ñ |
| Business logic | âŒ ĞĞµÑ‚ |

---

## âš ï¸ ĞŸÑ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ñ€Ğ°ÑÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: Ğ”Ğ²Ğ¾Ğ¹Ğ½Ğ¾Ğ¹ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¸ÑÑ‚Ğ¸Ğ½Ñ‹

```
âŒ ĞĞ½Ñ‚Ğ¸Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½:
Frontend Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ÑĞ²Ğ¾Ñ ĞºĞ¾Ğ¿Ğ¸Ñ state
Backend Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ ÑĞ²Ğ¾Ñ ĞºĞ¾Ğ¿Ğ¸Ñ state
â†’ Ğ Ğ°ÑÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½ Ğ¿Ñ€Ğ¸ ÑĞµÑ‚ĞµĞ²Ñ‹Ñ… ÑĞ±Ğ¾ÑÑ…
```

### Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: Event Sourcing

```
âœ… ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´:
Backend = Source of Truth (events + derived state)
Frontend = Projection (derived from events)

ĞŸÑ€Ğ¸ disconnect:
1. Frontend Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ "Reconnecting..."
2. ĞŸÑ€Ğ¸ reconnect: Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ StateSnapshot
3. Frontend Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ ÑĞ²Ğ¾Ğ¹ state
```

### Checklist Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ event type

- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² EventType enum
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ TypeScript interface
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ° Python dataclass
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ handler Ğ² EventBus
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ handler Ğ² Frontend store
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² events table insert
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² state derivation logic
- [ ] ĞĞ°Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ Ñ‚ĞµÑÑ‚Ñ‹
