# üîí –ú–æ–¥–µ–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–¶–µ–ª—å:** –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—â–∏—Ç—ã –¥–ª—è tool_use, —Ñ–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –∏–∑–æ–ª—è—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤.

---

## üéØ –ü—Ä–∏–Ω—Ü–∏–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **Principle of Least Privilege** ‚Äî –∞–≥–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞
2. **Defense in Depth** ‚Äî –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞
3. **Fail Secure** ‚Äî –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–∏—Å—Ç–µ–º–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç, –∞ –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç
4. **Audit Trail** ‚Äî –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

---

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (3+1 —É—Ä–æ–≤–Ω—è)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LEVEL 0: User Approval Mode                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ DEFAULT | AUTO_EDIT | YOLO | PLAN                           ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LEVEL 1: Tool Allowlist                                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –ø—Ä–æ–µ–∫—Ç–∞              ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LEVEL 2: Filesystem Sandbox                                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ –û–ø–µ—Ä–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –≤ project_dir –∏ worktree                    ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LEVEL 3: OS Sandbox (Optional)                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ Docker / Bubblewrap / macOS Sandbox                          ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéö Level 0: Approval Modes

| Mode | –û–ø–∏—Å–∞–Ω–∏–µ | –†–∏—Å–∫ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|------|----------|------|---------------|
| `DEFAULT` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ | üü¢ –ù–∏–∑–∫–∏–π | –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫, –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã |
| `AUTO_EDIT` | –ê–≤—Ç–æ-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ | üü° –°—Ä–µ–¥–Ω–∏–π | –û–±—ã—á–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ |
| `YOLO` | –ê–≤—Ç–æ-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π | üî¥ –í—ã—Å–æ–∫–∏–π | –¢–æ–ª—å–∫–æ –≤ sandbox/isolated env |
| `PLAN` | –¢–æ–ª—å–∫–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | üü¢ –ù–∏–∑–∫–∏–π | –†–µ–≤—å—é, –∞–Ω–∞–ª–∏–∑ |

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É

```python
# –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ approval mode
def get_recommended_mode(project: Project, user_trust_level: int) -> ApprovalMode:
    if project.is_production:
        return ApprovalMode.DEFAULT
    
    if user_trust_level < 3:  # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        return ApprovalMode.DEFAULT
    
    if project.has_sensitive_data:
        return ApprovalMode.AUTO_EDIT
    
    if project.is_sandbox:
        return ApprovalMode.YOLO
    
    return ApprovalMode.AUTO_EDIT
```

---

## üîß Level 1: Tool Allowlist

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

```python
class ToolCategory(Enum):
    READ = "read"           # –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤, ls, grep
    WRITE = "write"         # –ó–∞–ø–∏—Å—å —Ñ–∞–π–ª–æ–≤
    EXECUTE = "execute"     # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
    NETWORK = "network"     # –°–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    GIT = "git"             # Git –æ–ø–µ—Ä–∞—Ü–∏–∏
    SYSTEM = "system"       # –°–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã
```

### –ú–∞—Ç—Ä–∏—Ü–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –ø–æ —Ç–∏–ø—É –ø—Ä–æ–µ–∫—Ç–∞

| Tool Category | Python | Node.js | Rust | Generic |
|---------------|--------|---------|------|---------|
| READ | ‚úÖ All | ‚úÖ All | ‚úÖ All | ‚úÖ All |
| WRITE | ‚úÖ .py, .txt, ... | ‚úÖ .js, .ts, ... | ‚úÖ .rs, .toml, ... | ‚úÖ Common files |
| EXECUTE | `python`, `pip`, `pytest` | `npm`, `node`, `yarn` | `cargo`, `rustc` | `ls`, `cat`, `grep` |
| NETWORK | `pip install` | `npm install` | `cargo build` | ‚ùå No |
| GIT | ‚úÖ All | ‚úÖ All | ‚úÖ All | ‚úÖ All |
| SYSTEM | ‚ùå No | ‚ùå No | ‚ùå No | ‚ùå No |

### Allowlist –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
# .iflow/security.yaml
tool_allowlist:
  read:
    enabled: true
    extensions: ["*"]
    
  write:
    enabled: true
    extensions:
      - ".py"
      - ".md"
      - ".yaml"
      - ".json"
      - ".txt"
    blocked_paths:
      - ".env"
      - ".env.*"
      - "*.pem"
      - "*.key"
      - "**/secrets/**"
      
  execute:
    enabled: true
    allowed_commands:
      - "python"
      - "pip"
      - "pytest"
      - "black"
      - "ruff"
      - "git"
    blocked_patterns:
      - "rm -rf"
      - "sudo"
      - "chmod 777"
      - "curl.*|.*bash"
      - "wget.*|.*sh"
      
  network:
    enabled: false  # Disabled by default
    allowed_hosts: []
    
  git:
    enabled: true
    allowed_operations:
      - "status"
      - "add"
      - "commit"
      - "branch"
      - "checkout"
      - "merge"
      - "push"  # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class ToolValidationResult:
    allowed: bool
    reason: Optional[str] = None
    requires_approval: bool = False

class ToolValidator:
    def __init__(self, config: SecurityConfig):
        self.config = config
    
    def validate_tool_call(
        self, 
        tool_name: str, 
        args: dict, 
        approval_mode: ApprovalMode
    ) -> ToolValidationResult:
        
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        category = self._get_tool_category(tool_name)
        if not self.config.is_category_enabled(category):
            return ToolValidationResult(
                allowed=False,
                reason=f"Category {category} is disabled"
            )
        
        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        if tool_name in self.config.blocked_tools:
            return ToolValidationResult(
                allowed=False,
                reason=f"Tool {tool_name} is explicitly blocked"
            )
        
        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (–¥–ª—è execute)
        if category == ToolCategory.EXECUTE:
            cmd = args.get("command", "")
            validation = self._validate_command(cmd)
            if not validation.allowed:
                return validation
        
        # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–µ–π (–¥–ª—è read/write)
        if category in (ToolCategory.READ, ToolCategory.WRITE):
            path = args.get("path", "")
            validation = self._validate_path(path, category)
            if not validation.allowed:
                return validation
        
        # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ approval mode
        if category in self.config.requires_approval_categories:
            if approval_mode == ApprovalMode.DEFAULT:
                return ToolValidationResult(
                    allowed=True,
                    requires_approval=True
                )
        
        return ToolValidationResult(allowed=True)
    
    def _validate_command(self, cmd: str) -> ToolValidationResult:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã"""
        for pattern in self.config.blocked_patterns:
            if re.search(pattern, cmd, re.IGNORECASE):
                return ToolValidationResult(
                    allowed=False,
                    reason=f"Command matches blocked pattern: {pattern}"
                )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–≤–æ–π –∫–æ–º–∞–Ω–¥—ã –≤ –ø–∞–π–ø–µ
        first_cmd = cmd.split("|")[0].strip().split()[0]
        if first_cmd not in self.config.allowed_commands:
            return ToolValidationResult(
                allowed=False,
                reason=f"Command {first_cmd} is not in allowlist"
            )
        
        return ToolValidationResult(allowed=True)
    
    def _validate_path(self, path: str, category: ToolCategory) -> ToolValidationResult:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—É—Ç–∏ —Ñ–∞–π–ª–∞"""
        abs_path = Path(path).resolve()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ sandbox
        if not self._is_in_sandbox(abs_path):
            return ToolValidationResult(
                allowed=False,
                reason=f"Path {path} is outside sandbox"
            )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ blocked paths
        for pattern in self.config.blocked_paths:
            if fnmatch.fnmatch(str(abs_path), pattern):
                return ToolValidationResult(
                    allowed=False,
                    reason=f"Path matches blocked pattern: {pattern}"
                )
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (–¥–ª—è write)
        if category == ToolCategory.WRITE:
            ext = abs_path.suffix
            if ext not in self.config.allowed_extensions:
                return ToolValidationResult(
                    allowed=False,
                    reason=f"Extension {ext} is not allowed for writing"
                )
        
        return ToolValidationResult(allowed=True)
```

---

## üìÅ Level 2: Filesystem Sandbox

### –ì—Ä–∞–Ω–∏—Ü—ã sandbox

```
project_root/               ‚Üê –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ .iflow/                 ‚Üê –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (read-only –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤)
‚îú‚îÄ‚îÄ .git/                   ‚Üê Git –¥–∞–Ω–Ω—ã–µ (read-only, –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ git)
‚îú‚îÄ‚îÄ src/                    ‚Üê –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (read-write)
‚îú‚îÄ‚îÄ tests/                  ‚Üê –¢–µ—Å—Ç—ã (read-write)
‚îú‚îÄ‚îÄ docs/                   ‚Üê –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (read-write)
‚îú‚îÄ‚îÄ node_modules/           ‚Üê –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (read-only)
‚îú‚îÄ‚îÄ .venv/                  ‚Üê Python venv (read-only)
‚îî‚îÄ‚îÄ worktrees/              ‚Üê Git worktrees –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
    ‚îú‚îÄ‚îÄ agent_0/            ‚Üê Sandbox –∞–≥–µ–Ω—Ç–∞ 0
    ‚îú‚îÄ‚îÄ agent_1/            ‚Üê Sandbox –∞–≥–µ–Ω—Ç–∞ 1
    ‚îî‚îÄ‚îÄ ...
```

### –ü—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞

```python
@dataclass
class SandboxConfig:
    project_root: Path
    worktree_root: Path
    
    # –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    read_paths: List[str] = field(default_factory=lambda: ["**/*"])
    write_paths: List[str] = field(default_factory=lambda: [
        "src/**/*",
        "tests/**/*",
        "docs/**/*"
    ])
    
    # –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –ø—É—Ç–∏
    blocked_read: List[str] = field(default_factory=lambda: [
        ".env",
        ".env.*",
        "**/*.pem",
        "**/*.key",
        "**/secrets/**"
    ])
    
    blocked_write: List[str] = field(default_factory=lambda: [
        ".git/**/*",
        ".iflow/**/*",
        "node_modules/**/*",
        ".venv/**/*",
        "**/__pycache__/**/*"
    ])

class FilesystemSandbox:
    def __init__(self, config: SandboxConfig, agent_id: str):
        self.config = config
        self.agent_id = agent_id
        self.worktree = config.worktree_root / f"agent_{agent_id}"
    
    def can_read(self, path: Path) -> bool:
        abs_path = self._resolve_path(path)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ sandbox
        if not self._is_in_sandbox(abs_path):
            return False
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ blocked
        for pattern in self.config.blocked_read:
            if fnmatch.fnmatch(str(abs_path.relative_to(self.worktree)), pattern):
                return False
        
        return True
    
    def can_write(self, path: Path) -> bool:
        abs_path = self._resolve_path(path)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ sandbox
        if not self._is_in_sandbox(abs_path):
            return False
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ blocked
        for pattern in self.config.blocked_write:
            if fnmatch.fnmatch(str(abs_path.relative_to(self.worktree)), pattern):
                return False
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ allowed
        for pattern in self.config.write_paths:
            if fnmatch.fnmatch(str(abs_path.relative_to(self.worktree)), pattern):
                return True
        
        return False
    
    def _is_in_sandbox(self, path: Path) -> bool:
        try:
            path.resolve().relative_to(self.worktree)
            return True
        except ValueError:
            return False
    
    def _resolve_path(self, path: Path) -> Path:
        if path.is_absolute():
            return path.resolve()
        return (self.worktree / path).resolve()
```

---

## üê≥ Level 3: OS-Level Sandbox (Optional)

### Docker-based isolation

```yaml
# docker-compose.agent.yml
version: "3.8"
services:
  agent:
    image: auto-iflow-agent:latest
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
    volumes:
      - type: bind
        source: ${WORKTREE_PATH}
        target: /workspace
        read_only: false
      - type: bind
        source: ${PROJECT_ROOT}/.iflow
        target: /config
        read_only: true
    networks:
      - agent-network
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 4G
        reservations:
          memory: 1G

networks:
  agent-network:
    driver: bridge
    internal: true  # No internet access
```

### macOS Sandbox Profile

```scheme
;; agent.sb - macOS sandbox profile
(version 1)
(deny default)

;; Allow read access to worktree
(allow file-read*
    (subpath "${WORKTREE_PATH}"))

;; Allow write access to worktree (except sensitive)
(allow file-write*
    (subpath "${WORKTREE_PATH}")
    (require-not (subpath "${WORKTREE_PATH}/.git"))
    (require-not (regex #"\.env.*")))

;; Allow process execution for allowed commands
(allow process-exec
    (literal "/usr/bin/python3")
    (literal "/usr/local/bin/pip")
    (literal "/usr/bin/git"))

;; Deny network access
(deny network*)

;; Allow minimal system access
(allow sysctl-read)
(allow mach-lookup (global-name "com.apple.system.logger"))
```

---

## üìù Audit Trail

### Event logging

```python
@dataclass
class SecurityEvent:
    timestamp: datetime
    event_type: str  # "tool_call", "validation_failed", "sandbox_violation"
    agent_id: str
    session_id: str
    details: dict
    severity: str  # "info", "warning", "critical"

class SecurityLogger:
    def __init__(self, log_path: Path):
        self.log_path = log_path
        self.logger = logging.getLogger("security")
    
    def log_tool_call(self, agent_id: str, tool_name: str, args: dict, result: ToolValidationResult):
        event = SecurityEvent(
            timestamp=datetime.utcnow(),
            event_type="tool_call",
            agent_id=agent_id,
            session_id=self._get_session_id(),
            details={
                "tool": tool_name,
                "args": self._sanitize_args(args),
                "allowed": result.allowed,
                "reason": result.reason
            },
            severity="info" if result.allowed else "warning"
        )
        self._write_event(event)
    
    def log_sandbox_violation(self, agent_id: str, path: str, operation: str):
        event = SecurityEvent(
            timestamp=datetime.utcnow(),
            event_type="sandbox_violation",
            agent_id=agent_id,
            session_id=self._get_session_id(),
            details={
                "path": path,
                "operation": operation
            },
            severity="critical"
        )
        self._write_event(event)
        self._alert_admin(event)
    
    def _sanitize_args(self, args: dict) -> dict:
        """–£–±–∏—Ä–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–æ–≤"""
        sensitive_keys = {"password", "token", "secret", "key", "api_key"}
        return {
            k: "***REDACTED***" if k.lower() in sensitive_keys else v
            for k, v in args.items()
        }
```

---

## ‚úÖ Security Checklist

### –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –∞–≥–µ–Ω—Ç–∞

- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω approval mode
- [ ] –ó–∞–≥—Ä—É–∂–µ–Ω–∞ security config
- [ ] –°–æ–∑–¥–∞–Ω sandbox (worktree)
- [ ] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω logger

### –ù–∞ –∫–∞–∂–¥—ã–π tool call

- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ sandbox boundaries
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
- [ ] –ó–∞–ø—Ä–æ—Å approval (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### –ü–æ—Å–ª–µ —Å–µ—Å—Å–∏–∏

- [ ] –†–µ–≤—å—é security log
- [ ] Cleanup worktree
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ anomalies
